# 🧠 Backtester — Архитектура и поток данных

Этот документ описывает архитектуру backtesting‑приложения, поток выполнения, ответственность модулей и ключевые структуры данных.

Цель README — чтобы **новый разработчик мог быстро понять**:

* как устроена система
* какие модули за что отвечают
* какие данные и куда передаются

---

## 📌 Общая идея приложения

**Backtester** — это детерминированный торговый симулятор, который:

* запускает **параллельные бэктесты** по разным монетам и таймфреймам
* симулирует рынок на 1‑минутных данных
* управляет позициями и ордерами
* считает equity / drawdown
* формирует HTML‑отчёты (по тесту и общий summary)

---

## 🗺 Общая схема потока выполнения

```text
┌─────────────────────────────────────────────┐
│                 TestManager                 │
│  Формирует задачи, запускает параллельно    │
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│                  Runner                     |
│  Инициализация компонентов бэктеста         │
│  (Strategy, Manager, Engine, Portfolio)     │
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│              BacktestEngine.run             │
│  Главный цикл бэктеста                      |
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│         Итерация по OHLCV (HTF)             │
│  Для каждого бара                           |
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│        Strategy.find_entry_point            │
│  Анализ истории → торговый сигнал           │
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│              SignalHandler                  │
│  Интерпретация сигнала                      | 
└─────────────────────────────────────────────┘
        ▼                            ▼
┌───────────────────┐      ┌───────────────────────┐
│  PositionBuilder  │      │   PositionManager     │
│  Создание позиции │      │  Закрытие / отмена    │
│  Ордеров (TP/SL)  │      │  Управление статусами │
└───────────────────┘      └───────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│           ExecutionLoop (1m)                │
│  Проход по минутным барам                   │
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│             ExecutionEngine                 │
│  ENTRY / TP / SL                            |
│  Исполнение ордеров                         |
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│                Portfolio                    |
│  Баланс / Equity / Floating PnL             │
│  Обновление на каждом баре                  │
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│         Equity / Drawdown Curves            │
│  Временные ряды                             |
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│           MetricsCalculator                 │
│  Итоговая статистика                        |
└─────────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────┐
│          ReportGenerator (HTML)             │
│  Test Report / Summary Report               │
└─────────────────────────────────────────────┘
```

---

## 📦 Описание модулей

### 1️⃣ TestManager

**Ответственность:**

* формирование списка задач `(coin, timeframe)`
* параллельный запуск бэктестов
* управление `SummaryCollector`

**Вход:**

```python
config.COINS
config.TIMEFRAME_LIST
```

**Выход:**

* отчёты по каждому тесту
* общий summary‑отчёт

---

### 2️⃣ Runner

**Ответственность:**

* точка сборки компонентов
* не содержит бизнес‑логики

**Создаёт:**

```python
Strategy
PositionManager
ExecutionEngine
Portfolio
```

---

### 3️⃣ BacktestEngine

**Ответственность:**

* главный цикл тестирования
* оркестрация модулей

**Метод:**

```python
BacktestEngine.run(data_htf, data_1m)
```

---

### 4️⃣ Strategy

**Ответственность:**

* анализ рынка
* генерация торгового сигнала

**Интерфейс сигнала:**

```python
{
  "direction": LONG | SHORT,
  "price": Decimal,
  "take_profits": [...],
  "stop_losses": [...]
}
```

---

### 5️⃣ SignalHandler

**Ответственность:**

* интерпретация сигнала
* принятие торговых решений

**Логика:**

* нет позиции → `PositionBuilder`
* есть позиция + противоположный сигнал → закрытие

---

### 6️⃣ PositionBuilder

**Ответственность:**

* создание позиции
* генерация ENTRY / TP / SL ордеров

---

### 7️⃣ PositionManager

**Ответственность:**

* хранение всех позиций
* управление статусами
* история исполнений

**Структуры:**

```python
positions: dict[str, Position]
```

---

### 8️⃣ ExecutionLoop

**Ответственность:**

* проход по 1‑минутным барам
* синхронизация HTF → LTF

---

### 9️⃣ ExecutionEngine

**Ответственность:**

* симуляция исполнения ордеров
* изменение состояния позиций

---

### 🔟 Portfolio

**Ответственность:**

* баланс
* equity
* плавающий PnL

**Метод:**

```python
portfolio.on_bar(realized_pnl, floating_pnl)
```

---

### 1️⃣1️⃣ MetricsCalculator

**Ответственность:**

* агрегированная статистика
* не зависит от логики бэктеста

**Выход:**

```python
{
  total_pnl,
  winrate,
  sharpe,
  max_drawdown,
  trades
}
```

---

### 1️⃣2️⃣ ReportGenerator

**Ответственность:**

* генерация HTML‑отчётов
* сериализация данных

**Типы отчётов:**

* Test Report (один тест)
* Summary Report (все тесты)

---

## 🧬 Ключевые структуры данных

### Position

```python
Position:
  id
  symbol
  direction
  status
  bar_open
  bar_closed
  realized_pnl
  orders: list[Order]
```

### Order

```python
Order:
  id
  type (ENTRY, TP, SL)
  price
  volume
  status
  executed_bar
```

### PortfolioSnapshot

```python
{
  timestamp,
  balance,
  equity,
  floating_pnl
}
```

---

## ✅ Зачем это нужно

* быстрое погружение новых разработчиков
* понятные точки расширения
* безопасное добавление стратегий и execution‑логики
* отчёты не зависят от логики бэктеста

---

## 🚀 Возможные дальнейшие улучшения

* UML / PlantUML диаграммы
* Sequence Diagram (один бар)
* README для open‑source версии
* API‑документация
* Unified Runner для live‑торговли

---

**Проект готов к масштабированию и командной разработке.** 🚀
