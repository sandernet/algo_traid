"""# data_fetcher	
# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö/—Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.	
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API –±–∏—Ä–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Binance, Bybit). 
# –ó–∞–≥—Ä—É–∑–∫–∞ OHLCV-—Å–≤–µ—á–µ–π. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
"""
import os
import ccxt
import pandas as pd
import time
from datetime import datetime
from typing import Optional, List
from src.utils.logger import get_logger 
# from src.config.config import config

logger = get_logger(__name__)


# TODO: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–Ω–µ—Ç–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–∞

class DataFetcher:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏ —Å –ø–æ–º–æ—â—å—é –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–Ω–µ—Ç –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤.
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - symbol: –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'BTC/USDT').
    - timeframe: –í—Ä–µ–º–µ–Ω–Ω–æ–∏ÃÜ –∏–Ω—Ç–µ—Ä–≤–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, '1m' –¥–ª—è –º–∏–Ω—É—Ç–Ω—ã—Ö —Å–≤–µ—á–µ–π).
    - exchange_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–∏—Ä–∂–∏ –≤ ccxt (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'bybit').
    - limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–∏ÃÜ –Ω–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±–∏—Ä–∂–∏).
    
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞—á–∏–Ω–∞—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã.
    1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ä–∂–∏ ccxt.
    2. –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å –∫ API —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 'since' –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
    4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ DataFrame.
    5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
    """
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –º–æ–Ω–µ—Ç—ã –∏ –±–∏—Ä–∂–∏
    # ======================================================
    def __init__(self, coin, exchange,  directory: str): 
        try:
            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–∏—Ä–∂–∏
            self.exchange_id = exchange.get("EXCHANGE_ID")
            self.limit = exchange.get("LIMIT")
            
            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç –º–æ–Ω–µ—Ç—ã
            self.market_type = coin.get("MARKET_TYPE", "spot")   # spot | linear | inverse
            self.base = coin.get("SYMBOL")
            
            # –í—Ä–µ–º—è—Ñ—Ä–µ–π–º (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã —Ç–µ—Å—Ç—ã –º–æ–≥–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞—Ç—Ä–∏–±—É—Ç)
            self.timeframe = coin.get("TIMEFRAME")
            self.min_timeframe = coin.get("MIN_TIMEFRAME") if coin.get("MIN_TIMEFRAME") else "1"

            self.directory = directory
            # –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∏—Ä–∂—É –ø—Ä–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ (–∏–∑–±–µ–≥–∞–µ–º –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö).
            # –§–æ—Ä–º–∞—Ç —Å–∏–º–≤–æ–ª–∞ –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ccxt.
            self.symbol = self._detect_symbol_format()
        except Exception as e:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–∞: {e}")
            raise
        # self.file_extension = file_extension
        
    
    # -------------------------------------------------------------
    # –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ä–∂–∏ ccxt
    # -------------------------------------------------------------
    def _set_exchange(self):
        # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ä–∂–∏ ccxt
        try:
            exchange_class = getattr(ccxt, self.exchange_id.lower())
            # Bybit –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API-–∫–ª—é—á–µ–π –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (OHLCV)
            self.exchange = exchange_class({
                "enableRateLimit": True,
                "options": {
                    "defaultType": self.market_type
                }
                })
            
            # self.exchange.load_markets()
            # –ù–µ –≤—ã–∑—ã–≤–∞–µ–º _detect_symbol_format() –∑–¥–µ—Å—å ‚Äî —Å–∏–º–≤–æ–ª –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–∏—Ä–∂–∏.
            
            logger.info(f"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∏—Ä–∂–µ {self.exchange_id} —É—Å–ø–µ—à–Ω–æ.")
        except AttributeError:
            logger.error(f"–ë–∏—Ä–∂–∞ '{self.exchange_id}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π ccxt.")
            raise
        
    # -------------------------------------------
    # –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —Å–∏–º–≤–æ–ª–∞
    # -------------------------------------------
    def _detect_symbol_format(self) -> str:
        """
        Automatically detects correct symbol for chosen market type.
        Examples:
        spot: BTC/USDT
        linear: BTC/USDT:USDT
        inverse: BTC/USD
        """
                # markets = self.exchange.markets
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Bybit –∏ –¥—Ä—É–≥–∏—Ö –±–∏—Ä–∂
        if self.exchange_id.lower() == "bybit":
            if self.market_type == "linear":
                return f"{self.base}/USDT:USDT"
            elif self.market_type == "inverse":
                return f"{self.base}/USD"
            elif self.market_type == "spot":
                return f"{self.base}/USDT"

        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ —Å–∏–º–≤–æ–ª–∞ –¥–ª—è {self.base} –Ω–∞ {self.exchange_id}.")
        return self.base  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    
    # -------------------------------------------------------------
    # –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–æ–≤
    # -------------------------------------------------------------
    def _get_export_path(self, timeframe: str, file_extension: str = "csv") -> str:
        """
        –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
        """
        file_prefix = f"{self.symbol.replace('/', '_').replace(':', '_')}_{timeframe}_{self.exchange_id}"
        
        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –ò—Å–ø–æ–ª—å–∑—É–µ–º os.path.join() –≤–º–µ—Å—Ç–æ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫
        if file_extension == "csv":
            path = os.path.join(self.directory, "csv_files")
        else:  # xlsx
            path = os.path.join(self.directory, "excel")

        # 1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if not os.path.exists(path):
            os.makedirs(path)
            logger.info(f"–°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞: {path}")

        # 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        # –ü—Ä–∏–º–µ—Ä: BTC_USDT_15m_OHLCV.csv
        file_name = f"{file_prefix}_OHLCV.{file_extension}"
        
        return os.path.join(path, file_name)

    # -------------------------------------------------------------
    # –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞—Ç—ã –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
    # -------------------------------------------------------------
    def _convert_date_to_ms(self, date_str: str, is_end_date: bool = False) -> int:
        """
        –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É YYYY-MM-DD –≤ Unix-—Ç–∞–π–º—à—Ç–∞–º–ø –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (UTC).
        –î–ª—è –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã (is_end_date=True) —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è (23:59:59.999).
        """
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º pandas Timestamp –∏ value (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã –æ—Ç —ç–ø–æ—Ö–∏) –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ
            # –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (UTC).
            ts = pd.Timestamp(date_str)
            # –õ–æ–∫–∞–ª–∏–∑—É–µ–º –≤ UTC, –µ—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ TZ
            if ts.tzinfo is None:
                ts = ts.tz_localize('UTC')

            if is_end_date:
                # –ö–æ–Ω–µ—Ü –¥–Ω—è: 23:59:59.999
                ts = ts + pd.Timedelta(hours=23, minutes=59, seconds=59, milliseconds=999)

            # pd.Timestamp.value –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã; –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
            return int(ts.value // 1_000_000)
        except Exception:
            logger.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: {date_str}. –û–∂–∏–¥–∞–µ—Ç—Å—è 'YYYY-MM-DD'.")
            raise
    
    # -------------------------------------------------------------
    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –ù–ê–ó–ê–î –í–û –í–†–ï–ú–ï–ù–ò
    # -------------------------------------------------------------
    def _generic_fetcher(self, timeframe, start_date_ms: Optional[int] = None, end_date_ms: Optional[int] = None) -> Optional[pd.DataFrame]:
        """
        –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –ù–ê–ó–ê–î –í–û –í–†–ï–ú–ï–ù–ò.
        
        :param start_date_ms: –°–∞–º—ã–π —Ä–∞–Ω–Ω–∏–π —Ç–∞–π–º—à—Ç–∞–º–ø –≤ –º—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å.
        –ï—Å–ª–∏ None, –∑–∞–≥—Ä—É–∑–∫–∞ –∏–¥–µ—Ç –¥–æ —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–∞—Ç—ã.
        :param end_date_ms: –¢–∞–π–º—à—Ç–∞–º–ø –≤ –º—Å, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø –∑–∞–≥—Ä—É–∑–∫–∞ (—Å–∞–º–∞—è –Ω–æ–≤–∞—è –¥–∞—Ç–∞).
        –ï—Å–ª–∏ None, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
        """
        all_ohlcv: List[List] = []
        
        # 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∞–º–æ–π –Ω–æ–≤–æ–π —Å–≤–µ—á–∏)
        # –ï—Å–ª–∏ end_date_ms –Ω–µ —É–∫–∞–∑–∞–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞.
        since_ms = end_date_ms if end_date_ms is not None else int(time.time() * 1000)
        
        # 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å–∞–º–æ–π —Å—Ç–∞—Ä–æ–π —Å–≤–µ—á–∏)
        # –ï—Å–ª–∏ start_date_ms –Ω–µ —É–∫–∞–∑–∞–Ω, –∑–∞–≥—Ä—É–∑–∫–∞ –∏–¥–µ—Ç –¥–æ –∫–æ–Ω—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ (0).
        stop_ms = start_date_ms if start_date_ms is not None else 0 
        
        start_log = datetime.fromtimestamp(stop_ms / 1000).strftime('%Y-%m-%d') if stop_ms > 0 else "–Ω–∞—á–∞–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏"
        end_log = datetime.fromtimestamp(since_ms / 1000).strftime('%Y-%m-%d %H:%M:%S')
        logger.info(f"[{self.symbol}] –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ ({timeframe}) –ù–ê–ó–ê–î —Å {end_log} –¥–æ {start_log}...")
        error_count = 0

        while True:
            try:
                # 3. –ó–∞–ø—Ä–æ—Å: –º—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —á–∞–Ω–∫, –∫–æ—Ç–æ—Ä—ã–π –ó–ê–ö–ê–ù–ß–ò–í–ê–ï–¢–°–Ø –≤—Ä–µ–º–µ–Ω–µ–º since_ms
                # –§–∞–∫—Ç–∏—á–µ—Å–∫–∏, –º—ã –ø—Ä–æ—Å–∏–º ccxt –¥–∞—Ç—å –Ω–∞–º limit —Å–≤–µ—á–µ–π, –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏—Ö since_ms.
                # –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –±–∏—Ä–∂ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç–∞–∫–æ–π —Ä–µ–∂–∏–º, –µ—Å–ª–∏ since/until –Ω–µ —É–∫–∞–∑–∞–Ω—ã, 
                # –Ω–æ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –Ω–∞–∑–∞–¥ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä 'since' –∫–∞–∫ 'until' 
                # –∏–ª–∏ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É ccxt.
                ohlcv_chunk = self.exchange.fetch_ohlcv(
                    symbol=self.symbol,
                    timeframe=timeframe,
                    since=since_ms - 1000 * 60 * 60 * 24 * 365 * 10, # –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞, —á—Ç–æ–±—ã ccxt –º–æ–≥ –Ω–∞—á–∞—Ç—å, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ª—É—á—à–µ
                    limit=self.limit,
                    params={'until': since_ms} # –ò—Å–ø–æ–ª—å–∑—É–µ–º until/since, –µ—Å–ª–∏ –±–∏—Ä–∂–∞ —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
                )
                
                # --- –í–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: –ë–∏—Ä–∂–∏ –∏ ccxt ---
                # –°–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±: ccxt.exchange.fetch_ohlcv()
                # –ï—Å–ª–∏ –±–∏—Ä–∂–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 'until', ccxt –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ù–ê–ó–ê–î.
                # –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ, –ø–µ—Ä–µ–¥–∞—á–∞ None –≤ 'since' –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 'params={'until': since_ms}' 
                # —á–∞—Å—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç ccxt –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–≤–µ—á–∏ –¥–æ 'since_ms'.
                
                # –ï—Å–ª–∏ fetch_ohlcv –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 'until' —á–µ—Ä–µ–∑ params, 
                # –Ω–∞–º –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å chunk, –Ω–∞–π—Ç–∏ –µ–≥–æ –ø–µ—Ä–≤—ã–π —Ç–∞–π–º—à—Ç–∞–º–ø, 
                # –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ —Ç–æ—á–∫—É 'since' –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ –Ω–∞–∑–∞–¥. 
                # –ù–∏–∂–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º 'until' –∏ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ ccxt.

                if not ohlcv_chunk or len(ohlcv_chunk) < 2:
                    logger.info(f"[{self.symbol}] –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –∏–ª–∏ –º–µ–Ω–µ–µ –¥–≤—É—Ö —Å–≤–µ—á–µ–π. –î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏.")
                    break # –ö–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏

                # 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —á–∞–Ω–∫–∞
                first_timestamp = ohlcv_chunk[0][0]
                last_timestamp = ohlcv_chunk[-1][0]
                
                # –ï—Å–ª–∏ —Å–∞–º–∞—è —Å—Ç–∞—Ä–∞—è —Å–≤–µ—á–∞ (first_timestamp) —É–∂–µ —Å—Ç–∞—Ä—à–µ –Ω–∞—à–µ–π —Ç–æ—á–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (stop_ms)
                if first_timestamp <= stop_ms:
                    # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–≤–µ—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ —Ä–∞–º–∫–∏ 'stop_ms' (—Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ)
                    valid_chunk = [candle for candle in ohlcv_chunk if candle[0] >= stop_ms]
                    all_ohlcv.extend(valid_chunk)
                    logger.info(f"[{self.symbol}] –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –Ω–∞—á–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã.")
                    break # –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞
                
                # –û–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π: –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                valid_chunk = ohlcv_chunk 
                all_ohlcv.extend(valid_chunk)

                # 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 'since' (–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ –Ω–∞–∑–∞–¥)
                # –°–ª–µ–¥—É—é—â–∞—è —Ç–æ—á–∫–∞ "until" –±—É–¥–µ—Ç –Ω–∞ 1–º—Å —Ä–∞–Ω—å—à–µ —Å–∞–º–æ–π –ø–µ—Ä–≤–æ–π —Å–≤–µ—á–∏ –≤ —ç—Ç–æ–º —á–∞–Ω–∫–µ
                since_ms = first_timestamp - 1 
                
                # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                first_date = datetime.fromtimestamp(first_timestamp / 1000).strftime('%Y-%m-%d %H:%M:%S')
                logger.info(f"[{self.symbol}] –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å–≤–µ—á–µ–π: {len(valid_chunk)}. –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ù–ê–ó–ê–î —Å: {first_date}")
                
                # –ó–∞—â–∏—Ç–∞ –æ—Ç DoS
                time.sleep(self.exchange.rateLimit / 1000) 

            except ccxt.ExchangeError as e:
                # ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
                logger.error(f"[{self.symbol}] –û—à–∏–±–∫–∞ API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}. –ü–∞—É–∑–∞ 5—Å.")
                error_count += 1
                if error_count >= 3:
                    logger.critical(f"[{self.symbol}] –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ API. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏.")
                    return None
                time.sleep(5)
                continue
            except Exception as e:
                # ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
                logger.critical(f"[{self.symbol}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}", exc_info=True)
                return None

        # 6. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ DataFrame
        if not all_ohlcv:
            logger.warning(f"[{self.symbol}] –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
            return None

        df = pd.DataFrame(all_ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
        
        # –¢–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∑–∫–∞ —à–ª–∞ –æ—Ç –Ω–æ–≤–æ–≥–æ –∫ —Å—Ç–∞—Ä–æ–º—É, —Å–ø–∏—Å–æ–∫ all_ohlcv –±—É–¥–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–º.
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ.
        df.sort_values('timestamp', ascending=True, inplace=True) 
        df.drop_duplicates(subset=['timestamp'], inplace=True) 
        df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
        df.set_index('timestamp', inplace=True)
        
        logger.info(f"[{self.symbol}] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–≤–µ—á–µ–π {len(df)}. –î–∏–∞–ø–∞–∑–æ–Ω: {df.index.min()} - {df.index.max()}")
        
        return df

    # -------------------------------------------------------------
    # 1. –ú–ï–¢–û–î: –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥
    # -------------------------------------------------------------
    def fetch_entire_history(self, timeframe)-> Optional[pd.DataFrame]:
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é (–æ—Ç —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π –¥–æ —Ç–µ–∫—É—â–µ–π).
        """
        self._set_exchange()
        # start_date_ms=None –∏ end_date_ms=None –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç –ª–æ–≥–∏–∫—É "–≤–µ—Å—å –ø–µ—Ä–∏–æ–¥" –≤ _generic_fetcher
        return self._generic_fetcher(timeframe, start_date_ms=None, end_date_ms=None)
    
    # -------------------------------------------------------------
    # 2. –ú–ï–¢–û–î: –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    # -------------------------------------------------------------
    def fetch_history_range(self, timeframe, start_date: str, end_date: str) -> Optional[pd.DataFrame]:
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ). 
        –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: 'YYYY-MM-DD'.
        """
        start_ms = self._convert_date_to_ms(start_date, is_end_date=False)
        end_ms = self._convert_date_to_ms(end_date, is_end_date=True) # –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è!
        # TODO: –î–æ–±–∞–≤–∏—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –Ω—É–∂–Ω–æ–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–µ
        if start_ms >= end_ms:
            logger.error("–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã.")
            return None
        
        self._set_exchange()
        return self._generic_fetcher(timeframe, start_date_ms=start_ms, end_date_ms=end_ms)
    

    # -------------------------------------------------------------
    # 3. –ú–ï–¢–û–î: –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    # -------------------------------------------------------------
    def export_to_csv(self, df: pd.DataFrame, timeframe: str) -> Optional[str]:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Ñ–∞–π–ª —Ñ–æ—Ä–º–∞—Ç–∞ CSV.
        
        :param df: DataFrame —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
        :return: –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
        """
        if df is None or df.empty:
            logger.error(f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π DataFrame –¥–ª—è {self.symbol}.")
            return None
        
        # –ü—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        # file_prefix = f"{self.symbol.replace('/', '_')}_{self.timeframe}_{self.exchange_id}"
        file_path = self._get_export_path(timeframe, file_extension="csv" )
        
        try:
            # index=True —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏–Ω–¥–µ–∫—Å (—Ç–∞–π–º—à—Ç–∞–º–ø) –∫–∞–∫ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü
            df.to_csv(file_path, index=True)
            logger.info(f"[{self.symbol}] ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤: {file_path}")
            return file_path
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ CSV –¥–ª—è {self.symbol}: {e}")
            return None

    # -------------------------------------------------------------
    # –ú–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–∏ÃÜ–ª–∞
    # -------------------------------------------------------------
    def check_file_exists(self, timeframe: str, file_extension: str = "csv") -> bool:
        file_path = self._get_export_path(timeframe, file_extension)
        return os.path.exists(file_path)
    
    # -------------------------------------------------------------
    # 4. –ú–ï–¢–û–î: –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
    # -------------------------------------------------------------
    def export_to_excel(self, df: pd.DataFrame , timeframe: str = "1") -> Optional[str]:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Ñ–∞–π–ª —Ñ–æ—Ä–º–∞—Ç–∞ Excel (xlsx).
        
        :param df: DataFrame —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
        :return: –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
        """
        if df is None or df.empty:
            logger.error(f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π DataFrame –¥–ª—è {self.symbol}.")
            return None
        
        # –ü—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        # file_prefix = f"{self.symbol.replace('/', '_')}_{self.timeframe}"
        # file_path = self._get_export_path(directory, file_prefix, "xlsx")
        file_path = self._get_export_path(timeframe=timeframe,file_extension="xlsx")
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º ExcelWriter, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
            writer = pd.ExcelWriter(file_path, engine='openpyxl')
            df.to_excel(writer, sheet_name='OHLCV Data', index=True)
            writer.close()
            
            logger.info(f"[{self.symbol}] ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤: : {file_path}")
            return file_path
        except ImportError:
            logger.error("‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'openpyxl' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install openpyxl")
            return None
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Excel –¥–ª—è {self.symbol}: {e}")
            return None
        
    # -------------------------------------------------------------
    # 5. –ú–ï–¢–û–î: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV-—Ñ–∞–π–ª–∞
    # -------------------------------------------------------------
    def load_from_csv(self, file_type: str, timeframe: str = "1") -> Optional[pd.DataFrame]:
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ CSV-—Ñ–∞–π–ª–∞.

        :param file_path: –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ CSV-—Ñ–∞–π–ª—É.
        :return: DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
        """
        # –ü—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        # file_prefix = f"{self.symbol.replace('/', '_')}_{self.timeframe}"
        file_path = self._get_export_path(timeframe=timeframe, file_extension=file_type )
        
        if not os.path.exists(file_path):
            logger.error(f"‚ùå –§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {file_path}")
            return None

        logger.info(f"üíæ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞: {file_path}")
        
        try:
            # 1. –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            # index_col=0 —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (—Ç–∞–π–º—à—Ç–∞–º–ø) —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–æ–º.
            df = pd.read_csv(file_path, index_col=0)
            
            # 2. –ü–æ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–∫–∞–∫ –∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å –±–∏—Ä–∂–∏)
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞ (—Ç–∞–π–º—à—Ç–∞–º–ø–∞) –≤ datetime
            # –ò–º—è –∏–Ω–¥–µ–∫—Å–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–æ–º—É, —á—Ç–æ –º—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏ ('timestamp')
            df.index.name = 'timestamp' 
            df.index = pd.to_datetime(df.index)
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–∏—Å–ª–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏)
            for col in ['open', 'high', 'low', 'close', 'volume']:
                if col in df.columns:
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º pd.to_numeric —Å errors='coerce' –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
                    df[col] = pd.to_numeric(df[col], errors='coerce')
            
            # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
            df.dropna(inplace=True) 
            
            logger.info(f"‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—Å–µ–≥–æ —Å–≤–µ—á–µ–π: {len(df)}. –î–∏–∞–ø–∞–∑–æ–Ω: {df.index.min()} - {df.index.max()}")
            return df

        except FileNotFoundError:
            # –≠—Ç–∞ –æ—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–ª–æ–≤–ª–µ–Ω–∞ –≤ –Ω–∞—á–∞–ª–µ, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            logger.error(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
            return None
        except Exception as e:
            logger.critical(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ CSV-—Ñ–∞–π–ª–∞: {e}", exc_info=True)
            return None