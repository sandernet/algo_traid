<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f7f7f7;
        }

        h1, h2 {
            color: #333;
        }

        .header-box {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .stat-item {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #fff;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px 10px;
            text-align: left;
        }

        th {
            background: #e8e8e8;
        }

        .orders-container {
            margin: 5px 0 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: #f0f0f0;
            display: none;
        }

        .toggle-btn {
            cursor: pointer;
            color: #0077cc;
            font-weight: bold;
            text-decoration: underline;
        }

        .profit-positive { color: green; font-weight: bold; }
        .profit-negative { color: red; font-weight: bold; }

    </style>

    <script>
    function toggleDetails(id){
    const row = document.getElementById('det-' + id);
    if(row.style.display === 'none' || row.style.display === ''){
        row.style.display = 'table-row';
    } else {
        row.style.display = 'none';
    }
    }
    </script>
</head>



<body>

<!-- ======================== HEADER ======================== -->
<div class="header-box">
    <h1>{{ title }}</h1>

    <p><strong>Период:</strong> {{ period_start }} — {{ period_end }}</p>

    <div class="stats-grid">
        <div class="stat-item">
            <strong>Всего сделок:</strong><br>{{ stats.total_positions }}
        </div>
        <div class="stat-item">
            <strong>Общий PnL:</strong><br>
            <span class="{% if stats.total_pnl > 0 %}profit-positive{% elif stats.total_pnl < 0 %}profit-negative{% endif %}">
                {{ "%.2f"|format(stats.total_pnl) }}
            </span>
        </div>
        <div class="stat-item">
            <strong>Winrate:</strong><br>{{ "%.1f"|format(stats.winrate) }}%
        </div>
        <div class="stat-item">
            <strong>Прибыльных:</strong><br>{{ stats.wins }}
        </div>
        <div class="stat-item">
            <strong>Убыточных:</strong><br>{{ stats.losses }}
        </div>
    </div>
</div>



<!-- ======================== POSITIONS TABLE ======================== -->
<h2>Список позиций</h2>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Symbol</th>
            <th>Direction</th>
            <th>Статус</th>
            <th>Открыта</th>
            <th>Закрыта</th>
            <th>Объём</th>
            <th>Средняя цена</th>
            <th>Прибыль</th>
            <th>Ордеры</th>
        </tr>
    </thead>

    <tbody>
    {% for p in positions %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.symbol }}</td>
            <td>{{ p.direction }}</td>
            <td>{{ p.status }}</td>
            <td>{{ p.opened }}</td>
            <td>{{ p.closed }}</td>
            <td>{{ p.opened_volume }}</td>
            <td>{{ p.avg_entry_price }}</td>
            <td>
                <span class="{% if p.profit > 0 %}profit-positive{% elif p.profit < 0 %}profit-negative{% endif %}">
                    {{ "%.2f"|format(p.profit) }}
                </span>
            </td>

            <td>
                {% set uid = "orders_" ~ p.id %}
                <!-- <span class="toggle" onclick="toggleDetails('{{ loop.index }}')">more</span> -->
                <span class="toggle" onclick="toggleOrders('{{ uid }}')">
                    показать / скрыть
                </span>
            </td>
        </tr>

        <!-- ---------------- ORDERS BLOCK ---------------- -->
        <tr>
            <td colspan="10" style="padding:0;">
                <div class="orders-container" id="{{ uid }}">
                    {% if p.orders and p.orders|length > 0 %}
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Тип</th>
                                    <th>Статус</th>
                                    <th>Цена</th>
                                    <th>Объём</th>
                                    <th>Исполнено</th>
                                    <th>Направление</th>
                                    <th>Бар открытия</th>
                                    <th>Бар закрытия</th>
                                </tr>
                            </thead>

                            <tbody>
                            {% for o in p.orders %}
                                <tr>
                                    <td>{{ o.id }}</td>
                                    <td>{{ o.order_type }}</td>
                                    <td>{{ o.status }}</td>
                                    <td>{{ o.price }}</td>
                                    <td>{{ o.volume }}</td>
                                    <td>{{ o.filled }}</td>
                                    <td>{{ o.direction }}</td>
                                    <td>{{ o.created_bar }}</td>
                                    <td>{{ o.close_bar }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                    {% else %}
                        <em>Нет ордеров</em>
                    {% endif %}
                </div>
            </td>
        </tr>

    {% endfor %}
    </tbody>
</table>

</body>
</html>
