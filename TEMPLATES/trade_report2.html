<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f4f6f8;
        }

        h1, h2 { color: #333; }

        .header-box {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 7px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
            margin-top: 12px;
        }

        .stat-item {
            background: #fff;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.12);
            text-align: center;
            font-size: 14px;
        }


        /* ==== COLORS ==== */

        /* PnL */
        .profit-positive { color: #0a8a00; font-weight: bold; }
        .profit-negative { color: #d60000; font-weight: bold; }

        /* Position status colors */
        .status-open { color: #0077cc; font-weight: bold; }
        .status-closed { color: #009933; font-weight: bold; }
        .status-cancelled { color: #777; font-weight: bold; }
        .status-other { color: #d68400; font-weight: bold; }

        /* Order status colors */
        .order-filled { color: #009933; font-weight: bold; }
        .order-cancelled { color: #d60000; font-weight: bold; }
        .order-pending { color: #0077cc; font-weight: bold; }
        .order-other { color: #444; font-weight: bold; }

        /* Order type colors */
        .order-entry { color: #60671d; font-weight: bold; }
        .order-take_profit { color: #1e5929; font-weight: bold; }
        .order-stop_loss { color: #933408; font-weight: bold; }


        .dir-long {
            color: #0b8f22; /* зелёный */
            font-weight: bold;
        }
        .dir-short {
            color: #c92a2a; /* красный */
            font-weight: bold;
        }

        /* Tables */
        .table{width:100%;border-collapse:collapse;margin-top:10px}
        .table th,.table td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
        .table th{background:#f0f0f3}
        .tp-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            border: 1px solid #ccc;       /* общий тонкий бордюр */
            border-radius: 6px;
        }

        /* стили для ячеек вложенных таблиц */
        .tp-table th, .tp-table td {
            border: 1px solid #ccc;       /* тонкий бордюр для ячеек */
            padding: 4px 6px;             /* уменьшенные отступы */
            font-size: 0.85em;
        }
        .tp-table tbody tr:hover {
            background-color: #e6f2ff;     /* светлый синий фон при наведении */
        }
        
        .details-row{display:none;background:#fafafa}
        .details-cell {
            padding: 10px;
            border-top: none;
        }
        tr:hover{background:#f5f5f5}

        .toggle-btn {
            cursor: pointer;
            color: #0077cc;
            font-weight: bold;
            text-decoration: underline;
        }
    </style>

    <script>
        function toggleDetails(id) {
            const block = document.getElementById(id);
            if(block.style.display === 'none' || block.style.display === ''){
                block.style.display = 'table-row';
            } else {
                block.style.display = 'none';
            }
        }   
    </script>
</head>



<body>

<!-- ====================================================== -->
<!--                      HEADER                             -->
<!-- ====================================================== -->

<div class="header-box">
    <h1>{{ title }}</h1>

    <p><strong>Период:</strong> {{ period_start }} — {{ period_end }}</p>

    <div class="stats-grid">

        <div class="stat-item">
            <strong>Всего сделок:</strong><br>{{ stats.total_positions }}
        </div>

        <div class="stat-item">
            <strong>Общий PnL:</strong><br>
            <span class="{% if stats.total_pnl > 0 %}profit-positive{% elif stats.total_pnl < 0 %}profit-negative{% endif %}">
                {{ "%.2f"|format(stats.total_pnl) }}
            </span>
        </div>

        <div class="stat-item">
            <strong>Winrate:</strong><br>{{ "%.1f"|format(stats.winrate) }}%
        </div>

        <div class="stat-item">
            <strong>Прибыльных:</strong><br>{{ stats.wins }}
        </div>

        <div class="stat-item">
            <strong>Убыточных:</strong><br>{{ stats.losses }}
        </div>

    </div>
</div>



<!-- ====================================================== -->
<!--                   POSITIONS TABLE                      -->
<!-- ====================================================== -->

<h2>Список позиций</h2>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Symbol</th>
            <th>Direction</th>
            <th>Статус</th>
            <th>Bar Opened</th>
            <th>Bar Closed</th>
            <th>Opened Vol</th>
            <th>Closed Vol</th>
            <th>Средняя цена</th>
            <th>Прибыль</th>
            <th>Ордеры</th>
        </tr>
    </thead>

    <tbody>

    {% for p in positions %}
        {% set uid = "orders_" ~ p.id %}
        {% set pstatus =
            "status-closed" if p.status == "closed"
            else "status-open" if p.status == "open"
            else "status-cancelled" if p.status == "cancelled"
            else "status-other"
        %}

        <tr>
            <td>{{ p.id[:6] }}</td>
            <td>{{ p.symbol }}</td>
            <td class="{{ 'dir-long' if p.direction == 'LONG' else 'dir-short' }}">
                {{ p.direction }}
            </td>
            <td class="{{ pstatus }}">{{ p.status }}</td>
            <td>{{ p.bar_opened }}</td>
            <td>{{ p.bar_closed }}</td>
            <td>{{ p.opened_volume }}</td>
            <td>{{ p.closed_volume }}</td>
            <td>{{ p.avg_entry_price }}</td>

            <td>
                <span class="{% if p.profit > 0 %}profit-positive{% elif p.profit < 0 %}profit-negative{% endif %}">
                    {{ "%.2f"|format(p.profit) }}
                </span>
            </td>

            <td>
                
                <span class="toggle-btn" onclick="toggleDetails('{{ uid }}')">показать</span>
            </td>
        </tr>

        <!-- ORDER LIST -->
        <tr id="{{ uid }}" class="details-row">
            <td colspan="11" class="details-cell">
                {% if p.orders and p.orders|length > 0 %}
                    <table class="tp-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Тип</th>
                                <th>Статус</th>
                                <th>Цена</th>
                                <th>Объем</th>
                                <th>Исполнено</th>
                                <th>Created Bar</th>
                                <th>Close Bar</th>
                                <th>Meta</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for o in p.orders %}
                            {% set ostatus =
                                "order-filled" if o.status == "FILLED"
                                else "order-cancelled" if o.status == "CANCELLED"
                                else "order-pending" if o.status == "PARTIAL"
                                else "order-other"
                            %}

                            {% set otype =
                                "order-entry" if o.order_type == "ENTRY"
                                else "order-take_profit" if o.order_type == "TAKE_PROFIT"
                                else "order-stop_loss" if o.order_type == "STOP_LOSS"
                            %}
                            <tr>
                                <td>{{ o.id[:6] }}</td>
                                <td class="{{ otype }}">{{ o.order_type }}</td>
                                <td class="{{ ostatus }}"">{{ o.status }}</td>
                                <td>{{ o.price }}</td>
                                <td>{{ o.volume }}</td>
                                <td>{{ o.filled }}</td>
                                <td>{{ o.created_bar }}</td>
                                <td>{{ o.close_bar }}</td>
                                <td>{{ o.meta }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <em>Нет ордеров</em>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

</body>
</html>
