# 🗺️ Карта проблем DataFetcher

## Визуальное представление проблем в коде

```
┌─────────────────────────────────────────────────────────────────┐
│                    DataFetcher Class                             │
└─────────────────────────────────────────────────────────────────┘
                               │
                ┌──────────────┼──────────────┐
                │              │              │
            ┌───▼────┐    ┌────▼────┐   ┌────▼────┐
            │ __init │    │_set_exch│   │_detect_ │
            │        │    │ange     │   │ symbol  │
            └───┬────┘    └────┬────┘   └────┬────┘
                │              │             │
         ❌ ОШИБКА #1:  ✅ ОК  │      ❌ ОШИБКА #2:
         Вызывает          │         Может быть
         _detect_symbol    └────────►вызван ДО
         ДО инициализации       инициализации
         self.exchange           self.exchange

┌─────────────────────────────────────────────────────────────────┐
│           Методы экспорта/импорта                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  _get_export_path()                                              │
│  ❌ ОШИБКА #3:                                                   │
│     path = self.directory+"csv_files"  ← Плохо!                 │
│     Должно быть: os.path.join(...)    ← Правильно!              │
│                                                                   │
│  export_to_csv()        ✅ ОК                                    │
│  export_to_excel()      ✅ ОК                                    │
│  load_from_csv()        ✅ ОК                                    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│           Работа с датами                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  _convert_date_to_ms()                                           │
│                                                                   │
│  ❌ ОШИБКА #4 - КРИТИЧЕСКАЯ:                                    │
│                                                                   │
│    dt = datetime.strptime(date_str, '%Y-%m-%d')                  │
│    return int(dt.timestamp() * 1000)                             │
│                   ↓                                               │
│    Использует локальное время вместо UTC!                        │
│                   ↓                                               │
│    На разных машинах разные результаты:                          │
│    • UTC+0:   1672531200000                                      │
│    • UTC-8:   1672502400000  (на 8 часов меньше)                │
│                   ↓                                               │
│    ИСПРАВЛЕНИЕ:                                                  │
│    dt = pd.Timestamp(date_str, tz='UTC')                         │
│    return dt.value // 1_000_000                                  │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│           Загрузка данных (_generic_fetcher)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ✅ ХОРОШО:                                                      │
│    • Логика пагинации понятна                                    │
│    • Обработка ошибок есть                                       │
│    • Логирование подробное                                       │
│                                                                   │
│  ⚠️ НУЖНО УЛУЧШИТЬ:                                              │
│    • Нет exponential backoff                                     │
│    • Нет отдельной обработки rate limit ошибок                  │
│    • Параметр 'since' вычисляется странно (вычитаем 10 лет!)    │
│                                                                   │
│  ❌ ПРОБЛЕМА:                                                    │
│    • Не все биржи поддерживают 'until' параметр                 │
│    • Может быть нестабильна на некоторых биржах                 │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток выполнения кода (с проблемами)

### Нормальный сценарий использования:

```
1. Создание объекта DataFetcher
   ├─ __init__(coin, exchange, directory)
   │  ├─ ✅ Устанавливает exchange_id, limit
   │  ├─ ✅ Устанавливает base (символ монеты)
   │  ├─ ❌ ОШИБКА: Вызывает _detect_symbol_format()
   │  │   └─ Но self.exchange еще не инициализирован!
   │  │   └─ Возвращает только self.base (например, "BTC")
   │  └─ ✅ Устанавливает directory
   │
   └─ ❌ РЕЗУЛЬТАТ: self.symbol = "BTC" (неправильно, должно "BTC/USDT")

2. Инициализация биржи
   └─ _set_exchange()
      ├─ ✅ Получает класс биржи из ccxt
      ├─ ✅ Создает объект биржи
      ├─ ✅ Вызывает _detect_symbol_format()
      │  └─ Но уже поздно! Неправильный symbol уже установлен
      └─ ✅ Логирует успех

3. Загрузка данных
   └─ fetch_entire_history(timeframe)
      └─ _generic_fetcher(timeframe)
         ├─ Определяет since_ms, stop_ms
         ├─ Цикл while True:
         │  ├─ ❌ fetch_ohlcv(symbol="BTC", ...)  ← НЕПРАВИЛЬНЫЙ СИМВОЛ!
         │  │   └─ Может вернуть ошибку от биржи
         │  ├─ Обработка чанка
         │  ├─ Обновление since_ms
         │  └─ Задержка (rate limit)
         │
         └─ ✅ Формирование DataFrame

4. Сохранение данных
   └─ export_to_csv(df, timeframe)
      ├─ _get_export_path(timeframe, "csv")
      │  ├─ Формирует file_prefix с "BTC_15m_binance"  ← НЕПРАВИЛЬНЫЙ!
      │  ├─ ❌ path = self.directory + "csv_files"  ← Неправильное объединение
      │  └─ ❌ Файл может быть сохранен неправильно
      └─ ✅ Сохранение в CSV
```

---

## 📊 Таблица зависимостей проблем

```
┌──────────────────────────────────────────────────────┐
│              ПРОБЛЕМА #1                             │
│   Ошибка инициализации символа                       │
└──────────────────┬───────────────────────────────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ CASCADING EFFECT │
          │    (каскадный    │
          │   эффект)        │
          └─────────────────┘
                   │
     ┌─────────────┼─────────────┬─────────────┐
     │             │             │             │
     ▼             ▼             ▼             ▼
test_init      API fails     Неправ    неправ
failed         (неправ       пути к    имена
(symbol=       symbol)       файлам    файлов
"BTC")                       


┌──────────────────────────────────────────────────────┐
│              ПРОБЛЕМА #4                             │
│      Проблема с часовыми поясами                    │
└──────────────────┬───────────────────────────────────┘
                   │
                   ▼
    ┌──────────────────────────────┐
    │ Зависит от timezone машины   │
    │ (UTC-8, UTC+0, UTC+3 и т.д.) │
    └──────────────────────────────┘
                   │
     ┌─────────────┼──────────────┐
     │             │              │
     ▼             ▼              ▼
Тесты    Данные   Impossible
падают   сдвинуты  to debug
на       на часы  (работает на
разных             одной машине
машинах            но не на другой)
```

---

## 🎯 Граф вызовов функций

```
DataFetcher
│
├─ __init__()
│  ├─ ❌ Вызывает: _detect_symbol_format()
│  │              └─ Проблема: self.exchange не инициализирован
│  │
│  └─ ✅ Устанавливает: self.symbol = None (правильно после исправления)
│
├─ _set_exchange()
│  ├─ getattr(ccxt, self.exchange_id)
│  ├─ ✅ Вызывает: _detect_symbol_format()
│  │              └─ Успех! self.exchange уже инициализирован
│  │
│  └─ ✅ Устанавливает: self.symbol = результат
│
├─ fetch_entire_history(timeframe)
│  ├─ Вызывает: _set_exchange()
│  └─ Вызывает: _generic_fetcher(timeframe)
│
├─ fetch_history_range(start_date, end_date)
│  ├─ Вызывает: _convert_date_to_ms(start_date)
│  │           └─ ❌ Использует локальное время!
│  ├─ Вызывает: _convert_date_to_ms(end_date)
│  │           └─ ❌ Использует локальное время!
│  ├─ Вызывает: _set_exchange()
│  └─ Вызывает: _generic_fetcher(timeframe)
│
├─ _generic_fetcher(timeframe, start_date_ms, end_date_ms)
│  ├─ Цикл загрузки данных
│  │  └─ self.exchange.fetch_ohlcv(symbol=self.symbol, ...)
│  │
│  └─ Формирование DataFrame
│     └─ Вызывает: _validate_dataframe() (после исправления)
│
├─ export_to_csv(df, timeframe)
│  ├─ Вызывает: _get_export_path(timeframe, "csv")
│  │           └─ ❌ path = self.directory + "csv_files"
│  └─ df.to_csv(file_path)
│
├─ export_to_excel(df, timeframe)
│  ├─ Вызывает: _get_export_path(timeframe, "xlsx")
│  │           └─ ❌ path = self.directory + "excel"
│  └─ df.to_excel(file_path)
│
└─ load_from_csv(file_type, timeframe)
   ├─ Вызывает: _get_export_path(timeframe, file_type)
   └─ pd.read_csv(file_path)
      └─ Вызывает: _validate_dataframe() (после исправления)
```

---

## 🔬 Анализ тестов и их связь с проблемами

```
ТЕСТ                              СТАТУС   СВЯЗАННАЯ ПРОБЛЕМА
────────────────────────────────  ────────  ──────────────────────────
test_init_sets_attributes         ❌ FAIL   #1 (неправильный symbol)
test_convert_date_to_ms_start    ❌ FAIL   #4 (часовой пояс UTC-8)
test_convert_date_to_ms_end      ❌ FAIL   #4 (часовой пояс UTC-8)
test_convert_date_invalid_format  ✅ PASS   (обработка ошибок работает)
test_get_export_path_csv         ❌ FAIL   #1 (неправильный symbol)
test_get_export_path_xlsx        ❌ FAIL   #1 (неправильный symbol)
test_generic_fetcher_successful  ❌ FAIL   @patch путь неправильный
test_generic_fetcher_empty_resp   ❌ FAIL   @patch путь неправильный
test_export_to_csv               ✅ PASS   (работает правильно)
test_load_from_csv               ✅ PASS   (работает правильно)
test_load_from_csv_file_not_found ✅ PASS   (обработка ошибок работает)
test_fetch_history_range_invalid  ✅ PASS   (валидация работает)

ИТОГО: 5 passed / 7 failed
```

---

## 📈 Прогнозируемый результат после исправлений

```
До исправлений:        После исправлений:
━━━━━━━━━━━━━━━━       ━━━━━━━━━━━━━━━━
PASSED: 5 (42%)        PASSED: 12 (100%) ✅
FAILED: 7 (58%)        FAILED: 0

КАЧЕСТВО КОДА:         КАЧЕСТВО КОДА:
━━━━━━━━━━━━━━━        ━━━━━━━━━━━━━
⚠️ 6/10                ✅ 8/10

ПОКРЫТИЕ:              ПОКРЫТИЕ:
━━━━━━━━━━━━━━━        ━━━━━━━━━━━━
~60%                   ~85%+

Type Hints:            Type Hints:
━━━━━━━━━━━━━━━        ━━━━━━━━━━━━
~20%                   ~90%+

Документация:          Документация:
━━━━━━━━━━━━━━━        ━━━━━━━━━━━━
~30%                   ~90%+
```

---

## 🛠️ Порядок исправления (по зависимостям)

```
ШАГ 1: Исправить #1 (инициализация символа)
       └─ Все остальные проблемы зависят от правильного symbol
       └─ Исправляет: 4 теста

       ┌─────────────────────────────────────┐
       │ test_init_sets_attributes ✅        │
       │ test_get_export_path_csv ✅        │
       │ test_get_export_path_xlsx ✅       │
       │ test_generic_fetcher_* ✅ (может) │
       └─────────────────────────────────────┘

ШАГ 2: Исправить #4 (часовые пояса)
       └─ Самостоятельная проблема
       └─ Исправляет: 2 теста

       ┌─────────────────────────────────────┐
       │ test_convert_date_to_ms_start ✅   │
       │ test_convert_date_to_ms_end ✅     │
       └─────────────────────────────────────┘

ШАГ 3: Исправить #3 (пути на Windows)
       └─ Может быть скрытой проблемой
       └─ Исправляет: экспорт файлов работает правильно

ШАГ 4: Исправить @patch пути в тестах
       └─ Исправляет: 2 теста

       ┌─────────────────────────────────────┐
       │ test_generic_fetcher_successful ✅ │
       │ test_generic_fetcher_empty_resp ✅ │
       └─────────────────────────────────────┘

ИТОГОВЫЙ РЕЗУЛЬТАТ: Все 12 тестов должны пройти! ✅
```

---

## 🎓 Категоризация проблем по типам

### Логические ошибки (Logic Bugs)
- ❌ #1: Вызов `_detect_symbol_format()` до инициализации биржи
- ❌ #2: Жесткое кодирование Bybit в `_detect_symbol_format()`

### Проблемы с временем (Timezone Issues)
- ❌ #4: Использование локального времени вместо UTC

### Проблемы с путями (Path Issues)
- ❌ #3: Строковое сложение вместо `os.path.join()`

### Проблемы с тестами (Test Issues)
- ❌ Неправильные пути в `@patch` декораторах

### Отсутствие валидации (Validation Issues)
- ❌ #5: Нет проверки входных параметров
- ❌ Нет валидации DataFrame

### Проблемы с обработкой ошибок (Error Handling)
- ⚠️ Нет exponential backoff
- ⚠️ Нет отдельной обработки rate limit ошибок

---

